# TP2 : Environnement virtuel

## Compte-rendu

☀️ Sur **`node1.lan1.tp2`** :

- afficher ses cartes réseau :

```
[cquentin@node1lan1tp2 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:b0:89:c5 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.11/24 brd 10.1.1.255 scope global noprefixroute enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:feb0:89c5/64 scope link
       valid_lft forever preferred_lft forever
```

- afficher sa table de routage :

```
[cquentin@node1lan1tp2 ~]$ ip route
10.1.1.0/24 dev enp0s8 proto kernel scope link src 10.1.1.11 metric 100
```

- prouvez qu'il peut joindre `node2.lan2.tp2` : 

```
[cquentin@node1lan1tp2 ~]$ ping 10.1.2.11

PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=9.89 ms

--- 10.1.2.11 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4015ms
rtt min/avg/max/mdev = 5.147/12.885/22.740/5.956 m
```

prouvez avec un `traceroute` que le paquet passe bien par `router.tp2` :

```
[cquentin@node1lan1tp2 ~]$ traceroute  10.1.2.11

traceroute to 10.1.2.11 (10.1.2.11), 30 hops max, 60 byte packets
 1  10.1.1.254 (10.1.1.254)  2.771 ms  2.571 ms  3.004 ms
 2  10.1.2.11 (10.1.2.11)  6.232 ms !X  8.298 ms !X  6.849 ms !X
```

# II. Interlude accès internet

![No internet](./img/no%20internet.jpg)

**On va donner accès internet à tout le monde.** Le routeur aura un accès internet, et permettra à tout le monde d'y accéder : il sera la passerelle par défaut des membres du LAN1 et des membres du LAN2.

**Ajoutez une carte NAT au routeur pour qu'il ait un accès internet.**

☀️ **Sur `router.tp2`**

- prouvez que vous avez un accès internet (ping d'une IP publique) : 

```
[cquentin@routeurtp2 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=115 time=22.9 ms

--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1004ms
rtt min/avg/max/mdev = 22.901/23.924/24.948/1.023 ms
```

- prouvez que vous pouvez résoudre des noms publics (ping d'un nom de domaine public) : 

```
[cquentin@routeurtp2 ~]$ ping google.com
PING google.com (216.58.214.78) 56(84) bytes of data.
64 bytes from fra15s10-in-f78.1e100.net (216.58.214.78): icmp_seq=1 ttl=114 time=24.2 ms

--- google.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1007ms
rtt min/avg/max/mdev = 24.214/26.303/28.393/2.089 ms
```

☀️ **Accès internet LAN1 et LAN2**


dans le compte-rendu, mettez-moi que la conf des points précédents sur `node2.lan1.tp2` :

```
[cquentin@node2lan1tp1 ~]$ ip route
default via 10.1.1.254 dev enp0s8
10.1.1.0/24 dev enp0s8 proto kernel scope link src 10.1.1.12 metric 100
10.1.2.0/24 via 10.1.1.254 dev enp0s8 proto static metric 100


[cquentin@node2lan1tp1 ~]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 8.8.8.8
nameserver 1.1.1.1
```
prouvez que `node2.lan1.tp2` a un accès internet :
  - il peut ping une IP publique :

```
[cquentin@node2lan1tp1 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=114 time=29.4 ms

--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1006ms
rtt min/avg/max/mdev = 29.427/32.217/35.008/2.790 ms
```
  - il peut ping un nom de domaine public :

```
[cquentin@node2lan1tp1 ~]$ ping google.com
PING google.com (172.217.18.206) 56(84) bytes of data.
64 bytes from par10s38-in-f14.1e100.net (172.217.18.206): icmp_seq=1 ttl=112 time=30.3 ms

--- google.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 30.252/33.485/36.719/3.233 ms
```

# III. Services réseau

## 1. DHCP

☀️ **Sur `dhcp.lan1.tp2`**

- n'oubliez pas de renommer la machine (`node2.lan1.tp2` devient `dhcp.lan1.tp2`) : 

```
[cquentin@dhcplan1tp1 ~]$
```

- changez son adresse IP en `10.1.1.253` :

```
[cquentin@dhcplan1tp1 ~]$ ip a

2: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:db:64:97 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.253/24 brd 10.1.1.255 scope global noprefixroute enp0s8 
```

- setup du serveur DHCP
  - commande d'installation du paquet : 

  ```
  [cquentin@dhcplan1tp1 ~]$ dnf -y install dhcp-server
  ```

  - fichier de conf :

  ```
  [cquentin@dhcplan1tp1 ~]$ sudo cat /etc/dhcp/dhcpd.conf

  [sudo] password for cquentin:
  #
  # DHCP Server Configuration file.
  #   see /usr/share/doc/dhcp-server/dhcpd.conf.example
  #   see dhcpd.conf(5) man page

  # default lease time
  default-lease-time 600;
  # max lease time
  max-lease-time 7200;
  # this DHCP server to be declared valid
  authoritative;
  # specify network address and subnetmask
  subnet 10.1.1.0 netmask 255.255.255.0 {
      # specify the range of lease IP address
      range dynamic-bootp 10.1.1.100 10.1.1.200;
      # specify broadcast address
      option broadcast-address 10.1.1.255;
      # specify gateway
      option routers 10.1.1.254;
  }
  ```
  - service actif :

  ```
  [cquentin@dhcplan1tp1 ~]$ sudo systemctl status dhcpd

     Active: active (running) since Sat 2023-10-21 21:25:20 CEST; 13h ago
  ```

☀️ **Sur `node1.lan1.tp2`**

- demandez une IP au serveur DHCP : 

```
[cquentin@node1lan1tp2 ~]$ sudo dhclient
```

- prouvez que vous avez bien récupéré une IP *via* le DHCP : 

```
[cquentin@node1lan1tp2 ~]$ cat /var/lib/dhclient/dhclient.leases .
lease

  option dhcp-server-identifier 10.1.1.253;
```

- prouvez que vous avez bien récupéré l'IP de la passerelle :

```
[cquentin@node1lan1tp2 ~]$ ip route
default via 10.1.1.254 dev enp0s8
```

- prouvez que vous pouvez `ping node1.lan2.tp2` :

```
[cquentin@node1lan1tp2 ~]$ ping 10.1.2.11
PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=2.34 ms

--- 10.1.2.11 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1003ms
rtt min/avg/max/mdev = 2.342/4.316/6.290/1.974 ms
```

## 2. Web web web

☀️ **Sur `web.lan2.tp2`**

  ```
  [cquentin@weblan2tp2 ~]$ sudo dnf install nginx

  [cquentin@weblan2tp2 ~]$ cat /etc/nginx/MA_conf.conf

  server {
        listen       80;
        listen       [::]:80;
        server_name  _;
        root         /var/www/site_nul;
  }
  ```

- service actif :

  ```
  [cquentin@weblan2tp2 ~]$ sudo systemctl status nginx

     Active: active (running) since Sun 2023-10-22 11:26:23 CEST; 5min ago
  ```

  - ouverture du port firewall : 

  ```
  sudo firewall-cmd --permanent --add-service=http
  ```
- prouvez qu'il y a un programme NGINX qui tourne derrière le port 80 de la machine (commande `ss`) :

```
[cquentin@weblan2tp2 ~]$ sudo ss -alnpt
State  Recv-Q  Send-Q   Local Address:Port   Peer Address:Port Process
LISTEN 0       511            0.0.0.0:80          0.0.0.0:*     users:(("nginx",pid=1342,fd=6),("nginx",pid=1341,fd=6))
```

- prouvez que le firewall est bien configuré :

```
[cquentin@weblan2tp2 ~]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: enp0s8
  sources:
  services: cockpit dhcpv6-client http ssh
  ports:
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

☀️ **Sur `node1.lan1.tp2`**

```
[cquentin@node1lan1tp2 ~]$ cat /etc/hosts

10.1.2.12 site_nul.tp2
[cquentin@node1lan1tp2 ~]$ curl site_nul.tp2

salut les gens
```